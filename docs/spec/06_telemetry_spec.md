# 06_telemetry_spec.md

## 行動計測（Telemetry）仕様

---

## ChangeLog

- 2026-01-11: 試験構成の呼称を「モジュール」から「セクション」に統一

## 1. 本資料の位置づけ

本資料は、社内SPIアプリにおける **行動計測（Telemetry）** の仕様を定義する。
ここで定義する計測値は **評価の材料**であり、単独で合否・不正判定を行うためのものではない。

---

## 2. 行動計測の目的

- 受験者が「適当に選択した可能性」「考えて選択した可能性」を推定する材料を得る
- 点数だけでは判断できない受験行動を可視化する
- 試験の難易度・問題設計改善のための分析材料とする

---

## 3. 基本方針（重要）

- 行動計測は **推定指標**である
- 計測結果のみで断定的判断を行わない
- ネットワーク遅延・ブラウザ挙動を考慮し、
  「完全な実時間」ではなく **観測可能な時間**として扱う
- 集計結果は Attempt 開始時点の条件に紐づく（スナップショット）

---

## 4. 計測対象単位

- 計測単位は **AttemptItem（問題単位）**
- セクション単位・試験全体の集計は、問題単位の集計結果から算出する

---

## 5. 計測する指標（確定）

### 5.1 observed_seconds

- 問題が画面に表示されていた合計時間
- VIEW ～ HIDE の差分を加算して算出する

### 5.2 active_seconds

- ユーザー操作が行われていたとみなせる時間
- 最後の操作から一定時間以内のみを active として加算する

### 5.3 view_count

- 問題が表示された回数
- 見直しや再表示の指標として使用する

### 5.4 answer_change_count

- 回答選択が変更された回数
- 迷い・再考の指標として使用する

---

## 6. アイドル判定（確定）

### 6.1 idle の定義

- 最後のユーザー操作から **15秒** 操作がなかった場合、idle と判定する

### 6.2 idle 時の扱い

- idle 中の時間は observed_seconds には含める
- idle 中の時間は active_seconds には含めない

---

## 7. 行動イベント定義

### 7.1 必須イベント

以下のイベントは必ず実装する。

| イベント      | 説明                   |
| ------------- | ---------------------- |
| VIEW          | 問題が画面に表示された |
| HIDE          | 問題画面を離れた       |
| ANSWER_SELECT | 回答を選択・変更した   |
| IDLE_START    | idle 状態に入った      |
| IDLE_END      | idle 状態から復帰した  |

---

### 7.2 任意イベント

以下は必要に応じて実装してもよい。

| イベント                    | 用途         |
| --------------------------- | ------------ |
| VISIBILITY_HIDDEN / VISIBLE | タブ切替検知 |
| HEARTBEAT                   | 接続生存確認 |

---

## 8. イベント記録ルール

- イベントは **時系列順で追記のみ**
- イベントは Route Handler 経由で記録する
- クライアント時刻は参考情報として保持してもよいが、
  **集計の正はサーバ時刻**とする

---

## 9. 集計ルール（確定）

### 9.1 observed_seconds の集計

- VIEW → HIDE の区間を加算
- 異常系（HIDE 未送信など）は以下のいずれかで区間を閉じる
  - セクション終了時刻
  - 試験提出時刻
  - セッション終了時刻

### 9.2 active_seconds の集計

- ANSWER_SELECT 等の操作イベント発生時点から 15 秒間を active とみなす
- IDLE_START 以降は active 加算を停止
- IDLE_END から再開する

---

## 10. 指標の解釈指針（業務向け）

以下は **例示**であり、断定ロジックではない。

- active_seconds が極端に短い問題が連続する
  → 早押し・適当選択の可能性
- observed は長いが active が短い
  → 放置・中断の可能性
- answer_change_count が多い
  → 熟考・迷いの可能性

---

## 11. 不変条件

- active_seconds ≤ observed_seconds
- idle 判定は常に 15 秒
- 計測値は Attempt 単位で固定され、後から再計算しない
- 行動計測のみで評価を完結させない

---

## 12. 次に読むべき資料

- `07_testing_strategy.md`
  （テスト戦略・E2E仕様）
