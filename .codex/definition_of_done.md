# .codex/definition_of_done.md

## Definition of Done（完了条件）

本ファイルは、社内SPIアプリにおける **作業完了の定義（DoD）** を明文化するものである。
Codex は、以下の条件を **すべて満たした場合のみ「完了」**と判断すること。

---

## 1. 仕様適合性（最優先）

- 実装内容が `docs/spec` 配下の仕様書に **完全に一致**している
- 仕様に記載された必須要件を **一切省略していない**
- 独自判断による簡略化・仕様変更を行っていない
- 仕様と実装の差異が存在しない

---

## 2. ビルド・起動条件

以下が **ローカルおよび CI 環境で再現可能**であること。

- `docker build` が成功する
- `docker compose up` でアプリが起動する
- DB マイグレーションが成功する
- seed データ投入が成功する
- 初期状態でエラーなくアクセスできる

---

## 3. テスト条件（必須）

### 3.1 Unit / Integration

- domain / usecase の主要ロジックに Unit テストが存在する
- DB を伴う処理に Integration テストが存在する
- テストは決定論的に動作する（時刻依存・乱数依存なし）

---

### 3.2 E2E（必須）

- Playwright による E2E テストが存在する
- 以下の動線が **必ずテストされている**
  - Candidate：ログイン → 試験開始 → 進行 → 提出
  - Staff：ログイン → ticket再発行 → 引き継ぎ
- E2E は CI 上で実行され、**成功している**
- Google SSO は E2E で使用していない

---

## 4. UI / テスト容易性

- E2E で操作する UI 要素には `data-testid` が付与されている
- 文言やレイアウトに依存したセレクタを使用していない
- 非同期処理は Playwright の expect により待機している
- 固定時間待機（sleep 等）を使用していない

---

## 5. セキュリティ・環境分離

- production ビルドに dev / test 専用機構が含まれていない
- 認証入口は環境別に分離されている
- 認可ロジックは全環境で共通である
- PIN や認証情報は平文保存されていない

---

## 6. コード品質・構造

- ディレクトリ構成が `08_project_structure_and_coding_rules.md` に準拠している
- `app/` 配下に業務ロジックが存在しない
- domain / usecase / infra の責務分離が守られている
- any の使用がない（例外は infra 層の境界のみ）

---

## 7. 状態遷移・不変条件

- Attempt / ExamVersion の状態遷移が仕様通りである
- 公開済み試験は編集不可
- 採点結果は不変で再計算されない
- 引き継ぎ時に状態・時間・回答が保持される
- idle=15秒ルールが厳密に守られている

---

## 8. ドキュメント・報告

- 変更内容が明確に説明されている
- 影響範囲が列挙されている
- 仕様書への追記が必要な論点があれば明示されている
- 「とりあえず動く」実装で終わらせていない

---

## 9. Done と見なさない例（明示）

以下はいずれか1つでも該当すれば **Done ではない**。

- テストが未実装、または一部スキップされている
- E2E が存在しない、または失敗している
- dev/test 専用コードが production に含まれている
- 仕様を簡略化したが理由を仕様書に反映していない
- TODO や FIXME を残したまま

---

## 10. 結論

本 DoD をすべて満たした状態のみが「完了」である。
部分的な達成や将来対応前提の実装は **完了とはみなさない**。
