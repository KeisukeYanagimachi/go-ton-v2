# .codex/workflow.md

## Codex 作業フロー（固定）

本ファイルは、社内SPIアプリにおいて Codex が作業する際の
**標準ワークフロー（思考順・実行順）**を定義する。

Codex は、どの作業内容であっても **必ずこのフローに従う**こと。

---

## 1. 全体フロー（必須）

すべての作業は、以下の 5 ステップで進める。

1. Read
2. Plan
3. Implement
4. Test
5. Report

いずれかのステップを省略してはならない。

---

## 2. Step 1: Read（仕様読解）

### 2.1 読むべき資料

作業開始前に、以下を必ず参照する。

- `AGENTS.md`
- `docs/spec/README.md`
- 作業対象に関連する仕様書（例：認証なら `04_auth_and_access_control.md`）

### 2.2 目的

- 対象機能の **業務的意味**を理解する
- 不変条件・禁止事項を再確認する
- 仕様の前提を取り違えない

---

## 3. Step 2: Plan（計画）

### 3.1 出力フォーマット（固定）

Plan フェーズでは、必ず以下を明示する。

- 作業の目的
- 対象仕様書（ファイル名 + セクション）
- 変更対象ファイル一覧
- 影響範囲（他 feature / テスト / 既存挙動）
- テスト戦略（Unit / Integration / E2E のどれで担保するか）

### 3.2 禁止事項

- 実装を始めてから Plan を書くこと
- Plan を曖昧な文章で済ませること

---

## 4. Step 3: Implement（実装）

### 4.1 実装ルール

- 変更は小さく、段階的に行う
- 仕様とコードの対応関係を常に意識する
- app/ 配下に業務ロジックを書かない
- 状態遷移は domain 層で表現する

### 4.2 記述上の注意

- TODO / FIXME を残さない
- any を使わない（infra 境界のみ例外）
- 型で制約を表現する

---

## 5. Step 4: Test（検証）

### 5.1 必須確認項目

- Unit テストが通る
- Integration テストが通る
- E2E テストが通る（該当範囲）

### 5.2 テスト実行に関する注意

- 固定時間待機は禁止
- data-testid を使用する
- テスト失敗時は原因を特定してから修正する

---

## 6. Step 5: Report（報告）

### 6.1 出力内容（固定）

Report フェーズでは、必ず以下を含める。

- 実装内容の要約
- 変更したファイル一覧
- テスト結果
- 注意点・副作用
- 仕様書に追記すべき論点（あれば）

### 6.2 禁止事項

- 「完了しました」だけで終わらせること
- テスト結果を省略すること

---

## 7. 判断が必要な場合の扱い

仕様上の判断が必要になった場合は、作業を止め、次を報告する。

- 判断が必要な理由
- 仕様書の該当箇所
- 選択肢とトレードオフ
- 推奨案（決定は行わない）

---

## 8. 本ワークフローの不変条件

- フローの順序は固定
- 手順の省略は禁止
- 作業内容に関わらず常に適用する

---

## 9. 目的の再確認

本ワークフローは、Codex の作業を機械的・再現的・安全に行うためのものである。
「速さ」よりも「正しさ」「一貫性」「仕様準拠」を優先する。
